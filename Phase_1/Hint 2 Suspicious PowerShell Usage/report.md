## 🚨 Suspicious PowerShell Usage – Malware Simulation

### 📌 Objective
Simulate suspicious PowerShell and malware-like behavior on the attacker Windows VM and verify detection through SIEM tools (Sysmon + Winlogbeat + Elasticsearch + Kibana + ElastAlert).

---

### 🧪 What Was Done

1. Created a PowerShell script (`malware-simulation.ps1`) that:
   - Created a directory for "malware".
   - Dropped a `.bat` file simulating a payload.
   - Added persistence via the registry and startup folder.
   - Launched the payload.
   - Made a simulated outbound HTTP request.
2. Malware Script:
  ![malware_script](https://github.com/user-attachments/assets/29521d96-17ae-4843-9e16-6bfbea4f5556)

3. Script executed using:
   ```powershell
   PowerShell -ExecutionPolicy Bypass -File C:\Scripts\malware-simulation.ps1
   ```

---

### 👁️ What Was Observed in the Logs

✅ Sysmon (via Event Viewer and Elasticsearch index `winlogbeat-*`) logged the following:

- **Event ID 1** – Process creation (`cmd.exe` running `malware.bat`)
- **Event ID 11** – File creation (`malware.bat`, `malware_startup.bat`)
- **Event ID 13** – Registry key for persistence

---

### 🧠 How SIEM Flagged the Event

✔️ **ElastAlert** was configured with a rule (`Suspicious PowerShell Usage - Malware Simulation.yaml`) to trigger if:

- Multiple Sysmon events (IDs 1, 11, or 13) were generated by PowerShell-related processes (`powershell.exe`, `cmd.exe`) with specific keywords like `malware.bat` or `Startup`.

✔️ The alert matched 5+ events within the specified timeframe.

📨 **Email Alert Sent** to the configured address via SMTP (Gmail).

---

## 📊 Data Source Mapping

| Log Source     | Event Type         | Event ID | Description                              |
|----------------|--------------------|----------|------------------------------------------|
| Sysmon         | Process Creation   | 1        | Execution of `powershell.exe`, `cmd.exe` |
| Sysmon         | File Creation      | 11       | Dropping of `malware.bat`, startup file  |
| Sysmon         | Registry Change    | 13       | Creation of persistence registry key     |
| Winlogbeat     | Log Forwarding     | -        | Transmitted all events to Elasticsearch  |

## 📩 Sample Alert (Email Screenshot)
![Screenshot 2025-05-21 223349](https://github.com/user-attachments/assets/77e5835a-5c9e-43f4-93bd-17433a5a8c8a)

### 🛡️ Analyst Action on Alert

- ✅ Verified alert in ElastAlert logs.
- ✅ Correlated event IDs and command line arguments in Kibana Discover.
- ✅ Confirmed registry and file activity from the simulated script.
- ✅ Took note that `example.com` in outbound HTTP is harmless.

---

### ⚠️ Possible False Positives

| 🧩 Impact Area          | 📌 Description                                                                   |
|-------------------------|----------------------------------------------------------------------------------|
| 🔔 Alert Fatigue        | Analysts overwhelmed by frequent safe alerts.                                   |
| ⏱ Time Waste            | Benign activity diverts attention from real threats.                            |
| 😕 Desensitization       | Important alerts may be overlooked if they resemble known false ones.           |
| 🔍 Analytical Bias      | Assumption of false positive leads to oversight.                                 |
| 📉 Reduced Trust        | In the alerting system or detection rule validity.                              |


🛠️ **Recommendation:** Whitelist known good script paths, users, or command-line arguments.

---

### 🧪 Detection Status

**✅ Successfully Triggered**

📬 **ElastAlert sent email alert** upon detecting the simulated PowerShell and malware behavior.
